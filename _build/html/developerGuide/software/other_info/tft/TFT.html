

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.2.3.4. Interfacing SPI TFT displays with touch &mdash; Red Pitaya 2.00-35 documentation</title>
      <link rel="stylesheet" href="https://media.readthedocs.org/css/sphinx_rtd_theme.css" type="text/css" />
      <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/page_width.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/new_style.css" type="text/css" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="3.2.3.5. Remote software deployment" href="../remote_software/remote_sw_deploy.html" />
    <link rel="prev" title="3.2.3.3. SPI interface" href="../spi/spi.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >


  <a href="https://redpitaya.com" target="_blank">



  
  <img src="../../../../_static/redpitaya-logo.svg" class="logo" />

</a>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../quickStart/quickStart.html">1. Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appsFeatures/appsFeatures.html">2. Applications and Features</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../devGuideTop.html">3. Developers guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../hardware/hardware.html">3.1. Hardware</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../software.html">3.2. Software</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../console/console_con.html">3.2.1. Console connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../build/build.html">3.2.2. Build &amp; compile instructions</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../info.html">3.2.3. Other useful information</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../os/network.html">3.2.3.1. Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="../gpio/gpio.html">3.2.3.2. General purpose input output</a></li>
<li class="toctree-l4"><a class="reference internal" href="../spi/spi.html">3.2.3.3. SPI interface</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.3.4. Interfacing SPI TFT displays with touch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../remote_software/remote_sw_deploy.html">3.2.3.5. Remote software deployment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../known_sw_issues/known_sw_issues.html">3.2.4. Known software issues</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../customization/custom.html">4. Customization services</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Red Pitaya</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../devGuideTop.html"><span class="section-number">3. </span>Developers guide</a></li>
          <li class="breadcrumb-item"><a href="../../software.html"><span class="section-number">3.2. </span>Software</a></li>
          <li class="breadcrumb-item"><a href="../info.html"><span class="section-number">3.2.3. </span>Other useful information</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.2.3.4. </span>Interfacing SPI TFT displays with touch</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="interfacing-spi-tft-displays-with-touch">
<h1><span class="section-number">3.2.3.4. </span>Interfacing SPI TFT displays with touch<a class="headerlink" href="#interfacing-spi-tft-displays-with-touch" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Instructions work for OS versions 0.97 and 0.98!</strong> (might also work on 1.04 OS version, but were not tested on there)</p>
<p>All the links in this section lead to the <a href="https://github.com/RedPitaya/RedPitaya/tree/release-2022.2/" target="_blank">2022.2 GitHub branch</a> (release 1.04-28) and the <a href="https://github.com/RedPitaya/RedPitaya-FPGA/tree/master" target="_blank">Red Pitaya FPGA repository</a>, where the files are present.</p>
</div>
<p>This document describes how to connect a
SPI interface-based TFT display with touch support
to the <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> connector, without the need for specific FPGA code.
The given setup has advantages and drawbacks.</p>
<p><strong>PROS:</strong></p>
<ul class="simple">
<li><p>It uses only <code class="docutils literal notranslate"><span class="pre">MIO</span></code> signals so it can be used with any FPGA image.</p></li>
<li><p>Only extension connector <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> is used.</p></li>
<li><p>SPI is not wired through the FPGA so maximum clock speeds can be used.</p></li>
</ul>
<p><strong>CONS:</strong></p>
<ul class="simple">
<li><p>MIO signals shared with SPI, I2C and UART are consumed.
So these interfaces can not be used for other purposes.</p></li>
<li><p>Onboard I2C EEPROM can not be accessed.
This might cause issues in programs that store
calibration data in the EEPROM.</p></li>
<li><p>Backlight control is not supported.</p></li>
</ul>
<div class="section" id="hardware-setup">
<h2><span class="section-number">3.2.3.4.1. </span>Hardware setup<a class="headerlink" href="#hardware-setup" title="Permalink to this heading"></a></h2>
<div class="section" id="pinctrl">
<h3><span class="section-number">3.2.3.4.1.1. </span>pinctrl<a class="headerlink" href="#pinctrl" title="Permalink to this heading"></a></h3>
<p>It is possible to reconfigure <strong>Zynq</strong> MIO signals using the <code class="docutils literal notranslate"><span class="pre">pinctrl</span></code> kernel driver.
This TFT display setup takes advantage of this by repurposing SPI, I2C, and UART signals
on the <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> connector as SPI and GPIO signals which are required by the TFT display interface.</p>
<p>The reconfiguration is performed by including the <a href="https://github.com/RedPitaya/RedPitaya-FPGA/blob/master/dts/tft/tft-E2.dtsi" target="_blank">tft-E2 device tree</a>.</p>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">download</dt>
<dd class="field-odd"><p><a href="https://github.com/RedPitaya/RedPitaya-FPGA/blob/master/dts/tft/tft-E2.dtsi" target="_blank">tft-E2 device tree</a></p>
</dd>
</dl>
</li>
</ul>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 6%" />
<col style="width: 12%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 12%" />
<col style="width: 6%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SPI TFT+touch</p></th>
<th class="head"><p>MIO</p></th>
<th class="head"><p>function</p></th>
<th class="head"><p>pin</p></th>
<th class="head"><p>pin</p></th>
<th class="head"><p>function</p></th>
<th class="head"><p>MIO</p></th>
<th class="head"><p>SPI TFT+touch</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
<td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">26</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">25</span></code></p></td>
<td><p>GND</p></td>
<td></td>
<td><p>GND</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>ADC_CLK-</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">24</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">23</span></code></p></td>
<td><p>ADC_CLK+</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">22</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">21</span></code></p></td>
<td><p>GND</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>AO[3]</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">20</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">19</span></code></p></td>
<td><p>AO[2]</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>AO[1]</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">18</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">17</span></code></p></td>
<td><p>AO[0]</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>AI[3]</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">16</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">15</span></code></p></td>
<td><p>AI[2]</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>AI[1]</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">14</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">13</span></code></p></td>
<td><p>AI[0]</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>I2C_GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">12</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">11</span></code></p></td>
<td><p>common</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>TFT RESETn</p></td>
<td><p>51</p></td>
<td><p>I2C SDA</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">9</span></code></p></td>
<td><p>I2C_SCK</p></td>
<td><p>50</p></td>
<td><p>SPI_SSs[1], touch</p></td>
</tr>
<tr class="row-odd"><td><p>touch pendown</p></td>
<td><p>9</p></td>
<td><p>UART_RX</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">8</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">7</span></code></p></td>
<td><p>UART_TX</p></td>
<td><p>8</p></td>
<td><p>TFT D/C</p></td>
</tr>
<tr class="row-even"><td><p>SPI_SSn[0], TFT</p></td>
<td><p>13</p></td>
<td><p>SPI_CS</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">6</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p></td>
<td><p>SPI_CLK</p></td>
<td><p>12</p></td>
<td><p>SPI_SCLK</p></td>
</tr>
<tr class="row-odd"><td><p>SPI_MISO</p></td>
<td><p>11</p></td>
<td><p>SPI_MISO</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p></td>
<td><p>SPI_MOSI</p></td>
<td><p>10</p></td>
<td><p>SPI_MOSI</p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td><p>-4V</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>+5V</p></td>
<td></td>
<td><p>+5V</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Since some of the signals share the I2C bus which already contains an EEPROM,
there is a possibility there will be functional conflicts.
Although the probability of the I2C EEPROM going into an active state is low.
I2C devices only react after an I2C start condition is present on the bus.
The start condition requires both SDA and SCL signals to be low at the same time.
Here it is assumed TFT display RESETn (active low) will not be active
at the same time as the touch controller SPI SSn (active low) signal.</p>
<p>Attempts to access the I2C EEPROM will not interfere with the display,
but they will return a timeout.
This might (probably will) cause issues with applications
using the I2C EEPROM, for example calibration access from <em>Oscilloscope</em> app.</p>
<p>There is no MIO pin left for backlight control,
the easiest solution is to hard wire the display backlight pin to VCC.</p>
</div>
<div class="section" id="spi-clock-speed">
<h3><span class="section-number">3.2.3.4.1.2. </span>SPI clock speed<a class="headerlink" href="#spi-clock-speed" title="Permalink to this heading"></a></h3>
<p>Only a limited set of SPI clock speeds can be set depending on
the clock driving the SPI controller.
The SPI controller itself provides only the power of 2 clock divider options.
See the <a class="reference external" href="https://www.xilinx.com/support/documentation/user_guides/ug585-Zynq-7000-TRM.pdf">Zynq TRM</a>
(section <em>B.30 SPI Controller (SPI)</em> register <code class="docutils literal notranslate"><span class="pre">BAUD_RATE_DIV</span></code>) for details.</p>
<p>The next table provides available frequencies for two SPI controller clock settings.
The maximum clock speed for this SPI controller is 50 MHz.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SPI controller clock</p></th>
<th class="head"><p>f/4</p></th>
<th class="head"><p>f/8</p></th>
<th class="head"><p>f/16</p></th>
<th class="head"><p>f/32</p></th>
<th class="head"><p>f/64</p></th>
<th class="head"><p>f/128</p></th>
<th class="head"><p>f/256</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>166.6 MHz</p></td>
<td><p>41.6</p></td>
<td><p>20.8</p></td>
<td><p>10.4</p></td>
<td><p>5.21</p></td>
<td><p>2.60</p></td>
<td><p>1.30</p></td>
<td><p>0.63</p></td>
</tr>
<tr class="row-odd"><td><p>166.6 MHz</p></td>
<td><p>41.6</p></td>
<td><p>20.8</p></td>
<td><p>10.4</p></td>
<td><p>5.21</p></td>
<td><p>2.60</p></td>
<td><p>1.30</p></td>
<td><p>0.63</p></td>
</tr>
<tr class="row-even"><td><p>200.0 MHz</p></td>
<td><p>50.0</p></td>
<td><p>25.0</p></td>
<td><p>12.5</p></td>
<td><p>6.25</p></td>
<td><p>3.125</p></td>
<td><p>1.56</p></td>
<td><p>0.781</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="software-setup">
<h2><span class="section-number">3.2.3.4.2. </span>Software setup<a class="headerlink" href="#software-setup" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">download</dt>
<dd class="field-odd"><p><a href="https://github.com/RedPitaya/RedPitaya/blob/release-2022.2/OS/debian/tft.sh" target="_blank">tft.sh</a></p>
</dd>
</dl>
</li>
</ul>
<p>Instructions for starting XFCE on the TFT display.
A script that can be used to generate an image with full support is available on GitHub tft.sh.</p>
<p>A set of Ubuntu/Debian packages should be installed:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">apt-get -y install \</span>
<span class="go">  python3 python3-numpy build-essential libfftw3-dev python3-scipy \</span>
<span class="go">  xfonts-base tightvncserver xfce4-panel xfce4-session xfwm4 xfdesktop4 \</span>
<span class="go">  xfce4-terminal thunar gnome-icon-theme \</span>
<span class="go">  xserver-xorg xinit xserver-xorg-video-fbdev</span>
</pre></div>
</div>
<ul class="simple">
<li><dl class="field-list simple">
<dt class="field-odd">download</dt>
<dd class="field-odd"><p><a href="https://github.com/RedPitaya/RedPitaya/blob/release-2022.2/OS/debian/overlay/usr/share/X11/xorg.conf.d/99-fbdev.conf" target="_blank">99-fbdev.conf</a></p>
</dd>
</dl>
</li>
</ul>
<p>An X11 configuration file should be added to the system 99-fbdev.conf.</p>
<p>Over SSH start the X server:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">startx</span>
</pre></div>
</div>
</div>
<div class="section" id="tested-supported-devices">
<h2><span class="section-number">3.2.3.4.3. </span>Tested/Supported devices<a class="headerlink" href="#tested-supported-devices" title="Permalink to this heading"></a></h2>
<p>The next table lists supported devices and corresponding device tree files each supporting a set of displays depending on the used TFT and touch drivers.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 6%" />
<col style="width: 12%" />
<col style="width: 11%" />
<col style="width: 16%" />
<col style="width: 17%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>screen name</p></th>
<th class="head" colspan="3"><p>specifications</p></th>
<th class="head" colspan="2"><p>technical details</p></th>
<th class="head" rowspan="2"><p>device tree</p></th>
</tr>
<tr class="row-even"><th class="head"><p>size</p></th>
<th class="head"><p>resolution</p></th>
<th class="head"><p>touch</p></th>
<th class="head"><p>TFT controller</p></th>
<th class="head"><p>touch controller</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p><a href="https://github.com/watterott/MI0283QT-Adapter" target="_blank">MI0283QT Adapter Rev 1.5</a></p></td>
<td><p>2.8”</p></td>
<td><p>240x320</p></td>
<td></td>
<td><p><a href="https://cdn-shop.adafruit.com/datasheets/ILI9341.pdf" target="_blank">ILI9341</a></p></td>
<td><p><a href="http://www.ti.com/lit/ds/symlink/ads7846.pdf" target="_blank">ADS7846</a></p></td>
<td><p><a href="https://github.com/RedPitaya/RedPitaya-FPGA/blob/master/dts/tft/tft-ili9341-ads7846.dtsi" target="_blank">tft-ili9341-ads7846.dtsi</a></p></td>
</tr>
<tr class="row-even"><td><p><a href="https://learn.adafruit.com/adafruit-pitft-3-dot-5-touch-screen-for-raspberry-pi" target="_blank">Adafruit PiTFT 3.5" Touch Screen for Raspberry Pi</a></p></td>
<td><p>3.5”</p></td>
<td><p>480x320</p></td>
<td><p>resistive</p></td>
<td><p><a href="https://cdn-shop.adafruit.com/datasheets/HX8357-D_DS_April2012.pdf" target="_blank">HX8357D</a></p></td>
<td><p><a href="https://cdn-shop.adafruit.com/datasheets/STMPE610.pdf" target="_blank"STMPE610</a></p></td>
<td><p><a href="https://github.com/RedPitaya/RedPitaya-FPGA/blob/master/dts/tft/tft-hx8357d-stmpe601.dtsi" target="_blank">tft-hx8357d-stmpe601.dtsi</a></p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="mi0283qt-adapter-rev-1-5">
<h3><span class="section-number">3.2.3.4.3.1. </span>MI0283QT Adapter Rev 1.5<a class="headerlink" href="#mi0283qt-adapter-rev-1-5" title="Permalink to this heading"></a></h3>
<p>The device is powered by <strong>+5V</strong>,
and it generates 3.3V using an onboard LDO.
Therefore all IO is 3.3V, so there are no conflicts.</p>
<p>Connector pinout based on the <a href="https://github.com/watterott/MI0283QT-Adapter" target="_blank">MI0283QT Adapter Rev 1.5</a>
<a class="reference external" href="https://github.com/watterott/MI0283QT-Adapter/blob/master/hardware/MI0283QT_v15.pdf">schematic</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 14%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 14%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SPI TFT+touch</p></th>
<th class="head"></th>
<th class="head"><p>pin</p></th>
<th class="head"><p>pin</p></th>
<th class="head"></th>
<th class="head"><p>SPI TFT+touch</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td><p>ADS_VREF</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">16</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">15</span></code></p></td>
<td><p>ADS_VBAT</p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ADS_AUX</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">14</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">13</span></code></p></td>
<td><p>ADS_IRQ</p></td>
<td><p>touch pendown</p></td>
</tr>
<tr class="row-even"><td><p>TFT D/C</p></td>
<td><p>BUSY-RS</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">12</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">11</span></code></p></td>
<td><p>A-ADS_CS</p></td>
<td><p>SPI_SSs[1], touch</p></td>
</tr>
<tr class="row-odd"><td><p>SPI_SCLK</p></td>
<td><p>A-SCL</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">9</span></code></p></td>
<td><p>SDO</p></td>
<td><p>SPI_MISO</p></td>
</tr>
<tr class="row-even"><td><p>SPI_MOSI</p></td>
<td><p>A-SDI</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">8</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">7</span></code></p></td>
<td><p>A-LCD_CS</p></td>
<td><p>SPI_SSn[0], TFT</p></td>
</tr>
<tr class="row-odd"><td><p>TFT RESETn</p></td>
<td><p>A-LCD_RST</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">6</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p></td>
<td><p>LCD_LED</p></td>
<td><p>backlight</p></td>
</tr>
<tr class="row-even"><td><p>+5V</p></td>
<td><p>VCC</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p></td>
<td><p>VCC</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>GND</p></td>
<td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Backlight control is not available on the <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> connector.
A simple solution is to connect the <strong>LCD_LED</strong> signal
to +5V VCC, this can be done with a simple jumper
between the two display connector pins.
Otherwise, it would be possible to repurpose a LED on Red Pitaya.</p>
<ul class="simple">
<li><p>:download:<a href="https://github.com/RedPitaya/RedPitaya/blob/release-2022.2/OS/debian/overlay/etc/udev/rules.d/95-ads7846.rules" target="_blank">95-ads7846.rules</a></p></li>
</ul>
<p>The 95-ads7846.rules UDEV rule will create a symbolik link <code class="docutils literal notranslate"><span class="pre">/dev/input/touchscreen</span></code>.</p>
</div>
<div class="section" id="adafruit-pitft-3-5">
<h3><span class="section-number">3.2.3.4.3.2. </span>Adafruit PiTFT 3.5”<a class="headerlink" href="#adafruit-pitft-3-5" title="Permalink to this heading"></a></h3>
<p>There are two versions of this display the older <strong>Assembled</strong>
(sometimes called <strong>Original</strong> and the newer <strong>Plus</strong>.</p>
<ul class="simple">
<li><p><a href="https://www.adafruit.com/product/2097" target="_blank">PiTFT - Assembled 480x320 3.5" TFT+Touchscreen for Raspberry Pi</a> (<a class="reference external" href="https://cdn-learn.adafruit.com/assets/assets/000/019/744/original/adafruit_products_2097_quarter_ORIG.jpg">high resolution image</a>)</p></li>
<li><p><a href="https://www.adafruit.com/product/2441" target="_blank">PiTFT Plus 480x320 3.5" TFT+Touchscreen for Raspberry Pi</a> (<a class="reference external" href="https://cdn-shop.adafruit.com/970x728/2441-11.jpg">high resolution image</a>)</p></li>
</ul>
<p>While the newer <strong>Plus</strong> version can be used out of the box,
The older <strong>Assembled</strong> requires hardware modifications,
for details <cite>see below &lt;assembled_hw_mods&gt;</cite>.</p>
<p>The device is powered by <strong>+5V</strong> (for backlight LED)
and <strong>+3.3V</strong> for TFT and touch controllers
(should be taken from the E1 connector on Red Pitaya).
Therefore all IO is 3.3V, so there are no conflicts.</p>
<p>Male connector pinout based on the <a href="https://learn.adafruit.com/adafruit-pitft-3-dot-5-touch-screen-for-raspberry-pi" target="_blank">Adafruit PiTFT 3.5" Touch Screen for Raspberry Pi</a>
<a class="reference external" href="https://cdn-learn.adafruit.com/assets/assets/000/019/763/original/adafruit_products_schem.png?1411058465">schematic</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SPI TFT+touch</p></th>
<th class="head"><p>pin</p></th>
<th class="head"><p>pin</p></th>
<th class="head"><p>SPI TFT+touch</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>SPI_SSs[1], touch</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">26</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">25</span></code></p></td>
<td><p>GND</p></td>
</tr>
<tr class="row-odd"><td><p>SPI_SSn[0], TFT</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">24</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">23</span></code></p></td>
<td><p>SPI_SCLK</p></td>
</tr>
<tr class="row-even"><td><p>TFT D/C</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">22</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">21</span></code></p></td>
<td><p>SPI_MISO</p></td>
</tr>
<tr class="row-odd"><td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">20</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">19</span></code></p></td>
<td><p>SPI_MOSI</p></td>
</tr>
<tr class="row-even"><td><p>touch pendown</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">18</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">17</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">16</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">15</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">14</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">13</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">12</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">11</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">10</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">9</span></code></p></td>
<td><p>GND</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">8</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">7</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>GND</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">6</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5</span></code></p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p><code class="docutils literal notranslate"><span class="pre">4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">3</span></code></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>+5V</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">2</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>+3.3V</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><p>:download:<a href="https://github.com/RedPitaya/RedPitaya/blob/release-2022.2/OS/debian/overlay/etc/udev/rules.d/95-stmpe.rules" target="_blank">95-stmpe.rules</a></p></li>
<li><p>:download:<a href="https://github.com/RedPitaya/RedPitaya/blob/release-2022.2/OS/debian/overlay/etc/X11/xorg.conf.d/99-calibration.conf" target="_blank">99-calibration.conf</a></p></li>
</ul>
<p>The 95-stmpe.rules UDEV rule will create a symbolic link <code class="docutils literal notranslate"><span class="pre">/dev/input/touchscreen</span></code>.</p>
<p>A calibration file should be added to the system 99-calibration.conf.</p>
<div class="section" id="block-diagram">
<h4><span class="section-number">3.2.3.4.3.2.1. </span>Block diagram<a class="headerlink" href="#block-diagram" title="Permalink to this heading"></a></h4>
<div class="figure align-center" id="id1">
<img alt="../../../../_images/TFT_connection.svg" src="../../../../_images/TFT_connection.svg" /><p class="caption"><span class="caption-text">Graphical representation of how to connect Red Pitayas <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> connetor to the Adafruit PiTFT 3.5”.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</div>
<div class="figure align-center" id="id2">
<img alt="../../../../_images/TFT_connection-table.svg" src="../../../../_images/TFT_connection-table.svg" /><p class="caption"><span class="caption-text">Simplified graphical representation of Red Pitayas <a class="reference internal" href="../../../hardware/125-14/extent.html#e2"><span class="std std-ref">E2</span></a> connetor to the Adafruit PiTFT 3.5”. For pin locations please look at the top picture.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</div>
</div>
<div class="section" id="assembled-version-hardware-modifications">
<span id="assembled-hw-mods"></span><h4><span class="section-number">3.2.3.4.3.2.2. </span>Assembled version hardware modifications<a class="headerlink" href="#assembled-version-hardware-modifications" title="Permalink to this heading"></a></h4>
<div class="section" id="explanation">
<h5><span class="section-number">3.2.3.4.3.2.2.1. </span>Explanation<a class="headerlink" href="#explanation" title="Permalink to this heading"></a></h5>
<p>The device is powered by a single <strong>+5V</strong> supply,
and it generates 3.3V using an on board LDO.
So 3.3V interfaces between Red Pitaya and the display
have a different power source on each side.
Since the two power sources do not wake up at the same time
there is a race condition affecting touch controller
SPI interface configuration during power-up reset.
The LDO on the TFT board is faster then the switcher on Red Pitaya.</p>
<p>The <a href="https://cdn-shop.adafruit.com/datasheets/STMPE610.pdf" target="_blank"STMPE610</a> touch controller datasheet (section 5.2)
describes how CPOL/CPHA SPI configuration options depend
on the power-up reset state of a pair of configuration pins.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 40%" />
<col style="width: 8%" />
<col style="width: 44%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>CPOL_N (I2C data/SPI CS pin)</p></th>
<th class="head"><p>CPOL</p></th>
<th class="head"><p>CPHA (I2C address/SPI MISO pin)</p></th>
<th class="head"><p>Mode</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
<td><p>3</p></td>
</tr>
</tbody>
</table>
<p>On the original setup (before <code class="docutils literal notranslate"><span class="pre">pinctrl</span></code> device tree is applied)
for the E2 connector, the touch chip SPI CS signal is used as I2C_SCK.
The SPI MISO pin is not affected by <code class="docutils literal notranslate"><span class="pre">pinctrl</span></code> changes.</p>
<p>There appears to be a race condition between:</p>
<ol class="arabic simple">
<li><p>the configuration read event timed by the STMPE610 power
coming directly from the +3.3V LDO (5V USB power connector)</p></li>
<li><p>and waking up of the 3.3V power supply on Red Pitaya,
which powers the pull-up resistors on the I2C pins
and FPGA pull-ups for the SPI MISO pin on the E2 connector</p></li>
</ol>
<p>In most cases, the LDO on the TFT board would wake
before the switcher on Red Pitaya, so the <code class="docutils literal notranslate"><span class="pre">CPOL_N</span></code>
would be detected as <code class="docutils literal notranslate"><span class="pre">0</span></code>, which inverts the SPI clock polarity.
As an unreliable fix, the <code class="docutils literal notranslate"><span class="pre">spi-cpol</span></code> attribute can be provided
in the <a href="https://github.com/RedPitaya/RedPitaya-FPGA/blob/master/dts/tft/tft-hx8357d-stmpe601.dtsi" target="_blank">tft-hx8357d-stmpe601.dtsi</a> device tree.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is not yet confirmed the power supply race condition is responsible
for touch not working in certain setups, more testing might be necessary.</p>
</div>
<p>The provided oscilloscope image shows a 3.3V power-up sequence
and its relation to SPI configuration signals.
It is evident configuration signals are stable.</p>
<p>Channels:</p>
<ol class="arabic simple">
<li><p><cite>CPHA</cite> (the signal is low during power-up),</p></li>
<li><p><cite>CPOL_N</cite> (the signal is linked to 3.3V with a pull-up and rising simultaneously),</p></li>
<li><p>3.3V (it takes about 1.5ms to ramp up from 0V to 3.3V).</p></li>
</ol>
<div class="figure align-center">
<img alt="../../../../_images/POR_SPI_config.png" src="../../../../_images/POR_SPI_config.png" />
</div>
</div>
<div class="section" id="modifications">
<h5><span class="section-number">3.2.3.4.3.2.2.2. </span>Modifications<a class="headerlink" href="#modifications" title="Permalink to this heading"></a></h5>
<p>To avoid the power supply race condition,
the LDO on the <strong>Assembled</strong> TFT board can be disabled,
and instead, +3.3V from Red Pitaya is used.
This makes the <strong>Assembled</strong> power supply similar to the <strong>Plus</strong> version.</p>
<p>The next modifications have to be done:</p>
<ol class="arabic simple">
<li><p>Remove the +3.3V LDO, or at least rise the power output pin of the board.</p></li>
<li><p>Connect pin 1 on the JP1 connector to a +3.3V power line.</p></li>
</ol>
<p>The next image shows a TFT board with a raised LDO power output
and pin 1 on the JP1 connector connected to an unmounted resistor pad.</p>
<div class="figure align-center">
<img alt="../../../../_images/assembled_hw_mod.jpg" src="../../../../_images/assembled_hw_mod.jpg" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="debugging-troubleshooting">
<h2><span class="section-number">3.2.3.4.4. </span>Debugging/Troubleshooting<a class="headerlink" href="#debugging-troubleshooting" title="Permalink to this heading"></a></h2>
<div class="section" id="pinctrl-gpio-and-interrupts">
<h3><span class="section-number">3.2.3.4.4.1. </span><code class="docutils literal notranslate"><span class="pre">pinctrl</span></code>, GPIO and interrupts<a class="headerlink" href="#pinctrl-gpio-and-interrupts" title="Permalink to this heading"></a></h3>
<p>To see current <code class="docutils literal notranslate"><span class="pre">pinctrl</span></code> settings try:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/kernel/debug/pinctrl/pinctrl-maps
</pre></div>
</div>
<p>To see the status of GPIO signals try:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/sys/kernel/debug/gpio
</pre></div>
</div>
<p>To see the status of interrupts try:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>/proc/interrupts
</pre></div>
</div>
</div>
<div class="section" id="touch">
<h3><span class="section-number">3.2.3.4.4.2. </span>Touch<a class="headerlink" href="#touch" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">evtest</span></code> can be used to see low-level touch events (and keyboard/mouse):</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="go">sudo apt-get install -y evtest</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../spi/spi.html" class="btn btn-neutral float-left" title="3.2.3.3. SPI interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../remote_software/remote_sw_deploy.html" class="btn btn-neutral float-right" title="3.2.3.5. Remote software deployment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Red Pitaya d.o.o..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>